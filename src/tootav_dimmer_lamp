#include <Wire.h>
#include "RTClib.h"
#include <Adafruit_NeoPixel.h>

#define NEOPIXEL_PIN 6
#define NUMPIXELS 16
#define BUTTON_PIN 7

RTC_DS3231 rtc;
Adafruit_NeoPixel pixels(NUMPIXELS, NEOPIXEL_PIN, NEO_GRB + NEO_KHZ800);

bool cycleActive = false;
unsigned long lastPressTime = 0;

const unsigned long fadeDuration = 10000UL;  // 10 s
const unsigned long waitDuration = 5000UL;   // 5 s

void setup() {
  Serial.begin(9600);
  delay(1000);
  Serial.println("Setup start");

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  Wire.begin();
  rtc.begin();
  pixels.begin();
  pixels.show();

  Serial.println("Ready! Press button to start.");
}

void loop() {
  // ---- simpler debounce ----
  if (digitalRead(BUTTON_PIN) == LOW && millis() - lastPressTime > 400) {
    lastPressTime = millis();
    cycleActive = !cycleActive;
    Serial.println(cycleActive ? "ðŸŒž Cycle STARTED" : "ðŸŒ™ Cycle STOPPED");

    if (cycleActive) flashIndicator();
    else setBrightness(0);
  }

  if (cycleActive) runLightCycle();
}

// ----- lighting control -----
void runLightCycle() {
  Serial.println("Fading DOWN...");
  fadeBrightness(255, 0, fadeDuration);

  Serial.println("Waiting (off)...");
  waitWithButtonCheck(waitDuration);

  Serial.println("Fading UP...");
  fadeBrightness(0, 255, fadeDuration);

  Serial.println("Cycle complete, repeating...");
}

void flashIndicator() {
  setBrightness(255);
  delay(2000);
  setBrightness(0);
  delay(500);
}

void fadeBrightness(int startValue, int endValue, unsigned long duration) {
  unsigned long startTime = millis();
  while (millis() - startTime < duration && cycleActive) {
    float progress = float(millis() - startTime) / duration;
    int brightness = startValue + (endValue - startValue) * progress;
    setBrightness(brightness);
    delay(100);
  }
  setBrightness(endValue);
}

void setBrightness(int level) {
  for (int i = 0; i < NUMPIXELS; i++)
    pixels.setPixelColor(i, pixels.Color(level, level, level));
  pixels.show();
}

void waitWithButtonCheck(unsigned long duration) {
  unsigned long startTime = millis();
  while (millis() - startTime < duration && cycleActive) {
    if (digitalRead(BUTTON_PIN) == LOW && millis() - lastPressTime > 400) {
      lastPressTime = millis();
      cycleActive = false;
      Serial.println("ðŸŒ™ Cycle STOPPED during wait.");
      break;
    }
    delay(200);
  }
}
